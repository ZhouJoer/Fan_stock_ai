"""
é‡åŒ–å®¡è®¡èŠ‚ç‚¹
ç”±AIè´Ÿè´£å®¡è®¡é‡åŒ–äº¤æ˜“ç»“æœï¼Œç›‘ç£å†³ç­–è´¨é‡ï¼Œè¯„ä¼°é£é™©
"""
from langchain_core.messages import HumanMessage, AIMessage
from graph.state import AgentState
from llm import llm
import json
import re


def quant_auditor_node(state: AgentState):
    """
    é‡åŒ–å®¡è®¡èŠ‚ç‚¹
    
    åŠŸèƒ½ï¼š
    1. å®¡è®¡é‡åŒ–ç­–ç•¥çš„åˆç†æ€§
    2. è¯„ä¼°å›æµ‹ç»“æœçš„å¯ä¿¡åº¦
    3. æ£€æŸ¥é£é™©æŒ‡æ ‡æ˜¯å¦åœ¨å¯æ¥å—èŒƒå›´
    4. ç›‘ç£äº¤æ˜“å†³ç­–çš„è´¨é‡
    5. ç»™å‡ºå®¡æ‰¹æ„è§ï¼ˆé€šè¿‡/æ‹’ç»/éœ€è¦æ”¹è¿›ï¼‰
    """
    messages = state["messages"]
    
    # è·å–é‡åŒ–äº¤æ˜“èŠ‚ç‚¹çš„æŠ¥å‘Š
    quant_report = None
    for msg in reversed(messages):
        if hasattr(msg, 'name') and msg.name == "Quant_Trader":
            quant_report = msg.content
            break
    
    if not quant_report:
        return {
            "messages": messages + [AIMessage(
                content="âš ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ°é‡åŒ–äº¤æ˜“æŠ¥å‘Šï¼Œæ— æ³•è¿›è¡Œå®¡è®¡ã€‚",
                name="Quant_Auditor"
            )]
        }
    
    # æå–å…³é”®æŒ‡æ ‡
    def extract_metric(text, pattern):
        match = re.search(pattern, text)
        return float(match.group(1)) if match else None
    
    total_return = extract_metric(quant_report, r'æ€»æ”¶ç›Šç‡ï¼š([\d.]+)%')
    annual_return = extract_metric(quant_report, r'å¹´åŒ–æ”¶ç›Šç‡ï¼š([\d.]+)%')
    sharpe_ratio = extract_metric(quant_report, r'å¤æ™®æ¯”ç‡ï¼š([\d.]+)')
    max_drawdown = extract_metric(quant_report, r'æœ€å¤§å›æ’¤ï¼š([\d.]+)%')
    win_rate = extract_metric(quant_report, r'èƒœç‡ï¼š([\d.]+)%')
    total_trades = extract_metric(quant_report, r'äº¤æ˜“æ¬¡æ•°ï¼š([\d.]+)ç¬”')
    
    # æ„å»ºå®¡è®¡æç¤º
    audit_prompt = f"""
    ä½ æ˜¯ä¸€ä½èµ„æ·±çš„é‡åŒ–äº¤æ˜“å®¡è®¡ä¸“å®¶å’Œé£é™©æ§åˆ¶ä¸“å®¶ï¼Œè´Ÿè´£å®¡è®¡é‡åŒ–ç­–ç•¥çš„æ‰§è¡Œç»“æœã€‚
    
    **é‡åŒ–äº¤æ˜“æŠ¥å‘Šæ‘˜è¦ï¼š**
    - æ€»æ”¶ç›Šç‡ï¼š{total_return}%
    - å¹´åŒ–æ”¶ç›Šç‡ï¼š{annual_return}%
    - å¤æ™®æ¯”ç‡ï¼š{sharpe_ratio}
    - æœ€å¤§å›æ’¤ï¼š{max_drawdown}%
    - èƒœç‡ï¼š{win_rate}%
    - äº¤æ˜“æ¬¡æ•°ï¼š{total_trades}ç¬”
    
    **å®Œæ•´æŠ¥å‘Šï¼š**
    {quant_report}
    
    è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œå…¨é¢å®¡è®¡ï¼š
    
    1. **æ”¶ç›Šè´¨é‡å®¡è®¡**
       - æ”¶ç›Šç‡æ˜¯å¦åˆç†ï¼ˆæ˜¯å¦è¿‡é«˜å¯èƒ½å­˜åœ¨è¿‡æ‹Ÿåˆï¼‰
       - æ”¶ç›Šæ˜¯å¦ç¨³å®šï¼ˆèƒœç‡ã€äº¤æ˜“é¢‘ç‡ï¼‰
       - ä¸å¸‚åœºåŸºå‡†å¯¹æ¯”
    
    2. **é£é™©æ§åˆ¶å®¡è®¡**
       - æœ€å¤§å›æ’¤æ˜¯å¦åœ¨å¯æ¥å—èŒƒå›´ï¼ˆå»ºè®®<20%ï¼‰
       - å¤æ™®æ¯”ç‡æ˜¯å¦è¾¾æ ‡ï¼ˆå»ºè®®>1.0ï¼‰
       - é£é™©æ”¶ç›Šæ¯”æ˜¯å¦åˆç†
    
    3. **ç­–ç•¥æœ‰æ•ˆæ€§å®¡è®¡**
       - äº¤æ˜“æ¬¡æ•°æ˜¯å¦åˆç†ï¼ˆè¿‡å°‘å¯èƒ½ä¸å…·ç»Ÿè®¡æ„ä¹‰ï¼Œè¿‡å¤šå¯èƒ½è¿‡åº¦äº¤æ˜“ï¼‰
       - èƒœç‡æ˜¯å¦å¥åº·ï¼ˆå»ºè®®>50%ï¼‰
       - ç­–ç•¥é€»è¾‘æ˜¯å¦æ¸…æ™°
    
    4. **è¿‡æ‹Ÿåˆé£é™©è¯„ä¼°**
       - æ˜¯å¦å­˜åœ¨è¿‡åº¦ä¼˜åŒ–å†å²æ•°æ®çš„è¿¹è±¡
       - å‚æ•°è®¾ç½®æ˜¯å¦è¿‡äºå¤æ‚
       - æ ·æœ¬å¤–è¡¨ç°é¢„æœŸ
    
    5. **æ‰§è¡Œé£é™©è¯„ä¼°**
       - æ»‘ç‚¹å’Œæ‰‹ç»­è´¹å½±å“
       - æµåŠ¨æ€§é£é™©
       - å¸‚åœºç¯å¢ƒå˜åŒ–é£é™©
    
    6. **åˆè§„æ€§æ£€æŸ¥**
       - æ˜¯å¦ç¬¦åˆé£é™©ç®¡ç†è§„å®š
       - æ˜¯å¦å­˜åœ¨å¼‚å¸¸äº¤æ˜“æ¨¡å¼
    
    **å®¡è®¡ç»“è®º**è¯·æ˜ç¡®ç»™å‡ºä»¥ä¸‹ä¹‹ä¸€ï¼š
    - âœ… **å®¡æ‰¹é€šè¿‡**ï¼šç­–ç•¥è¡¨ç°ä¼˜ç§€ï¼Œé£é™©å¯æ§ï¼Œå»ºè®®æ‰§è¡Œ
    - âš ï¸ **æœ‰æ¡ä»¶é€šè¿‡**ï¼šæ•´ä½“å¯è¡Œï¼Œä½†éœ€æ³¨æ„æŸäº›é£é™©ç‚¹ï¼Œå»ºè®®å°ä»“ä½è¯•éªŒ
    - âŒ **å®¡æ‰¹æ‹’ç»**ï¼šå­˜åœ¨é‡å¤§é—®é¢˜æˆ–é£é™©è¿‡é«˜ï¼Œä¸å»ºè®®æ‰§è¡Œ
    
    è¯·ä»¥ä¸“ä¸šã€ä¸¥è°¨ã€è´Ÿè´£çš„æ€åº¦ç»™å‡ºå®¡è®¡æ„è§ã€‚
    """
    
    # è°ƒç”¨LLMè¿›è¡Œå®¡è®¡
    response = llm.invoke(audit_prompt)
    audit_content = response.content
    
    # åˆ¤æ–­å®¡æ‰¹ç»“æœ
    approval_status = "æœªçŸ¥"
    if "å®¡æ‰¹é€šè¿‡" in audit_content or "âœ…" in audit_content:
        approval_status = "é€šè¿‡"
    elif "æœ‰æ¡ä»¶é€šè¿‡" in audit_content or "âš ï¸" in audit_content:
        approval_status = "æœ‰æ¡ä»¶é€šè¿‡"
    elif "å®¡æ‰¹æ‹’ç»" in audit_content or "âŒ" in audit_content:
        approval_status = "æ‹’ç»"
    
    # æ„å»ºå®¡è®¡æŠ¥å‘Š
    audit_report = f"""
=== ã€é‡åŒ–å®¡è®¡èŠ‚ç‚¹ã€‘Quant_Auditor å®¡è®¡æŠ¥å‘Š ===

ğŸ“‹ **å®¡è®¡ç›®æ ‡**ï¼šå¯¹é‡åŒ–äº¤æ˜“ç­–ç•¥è¿›è¡Œå…¨é¢å®¡è®¡å’Œé£é™©è¯„ä¼°

ğŸ“Š **å…³é”®æŒ‡æ ‡å®¡æŸ¥**ï¼š
- æ”¶ç›Šç‡ï¼š{total_return}% ï¼ˆå¹´åŒ–ï¼š{annual_return}%ï¼‰
- é£é™©æŒ‡æ ‡ï¼šæœ€å¤§å›æ’¤ {max_drawdown}%ï¼Œå¤æ™®æ¯”ç‡ {sharpe_ratio}
- äº¤æ˜“ç»Ÿè®¡ï¼š{total_trades}ç¬”äº¤æ˜“ï¼Œèƒœç‡ {win_rate}%

ğŸ” **AIå®¡è®¡åˆ†æ**ï¼š
{audit_content}

ğŸ“ **å®¡è®¡ç»“è®º**ï¼š{approval_status}

{'âœ… è¯¥é‡åŒ–ç­–ç•¥å·²é€šè¿‡AIå®¡è®¡ï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚' if approval_status == 'é€šè¿‡' else ''}
{'âš ï¸ è¯¥é‡åŒ–ç­–ç•¥æœ‰æ¡ä»¶é€šè¿‡ï¼Œè¯·æ³¨æ„é£é™©æ§åˆ¶ã€‚' if approval_status == 'æœ‰æ¡ä»¶é€šè¿‡' else ''}
{'âŒ è¯¥é‡åŒ–ç­–ç•¥æœªé€šè¿‡å®¡è®¡ï¼Œå»ºè®®é‡æ–°ä¼˜åŒ–æˆ–æ”¾å¼ƒæ‰§è¡Œã€‚' if approval_status == 'æ‹’ç»' else ''}

ğŸ¤– **AIç›‘ç£è¯´æ˜**ï¼š
æœ¬å®¡è®¡ç”±AIè‡ªåŠ¨å®Œæˆï¼ŒåŸºäºé‡åŒ–é‡‘èçš„æœ€ä½³å®è·µå’Œé£é™©ç®¡ç†åŸåˆ™ã€‚
å®¡è®¡è¿‡ç¨‹åŒ…æ‹¬ï¼šæ”¶ç›Šè´¨é‡åˆ†æã€é£é™©æ§åˆ¶è¯„ä¼°ã€ç­–ç•¥æœ‰æ•ˆæ€§éªŒè¯ã€è¿‡æ‹Ÿåˆæ£€æµ‹ã€æ‰§è¡Œé£é™©è¯„ä¼°ã€‚

âš ï¸ **é‡è¦æç¤º**ï¼š
- AIå®¡è®¡æ˜¯è¾…åŠ©å†³ç­–å·¥å…·ï¼Œæœ€ç»ˆå†³ç­–åº”ç”±äººç±»äº¤æ˜“å‘˜è´Ÿè´£
- å»ºè®®åœ¨å®ç›˜å‰è¿›è¡Œå°èµ„é‡‘æµ‹è¯•
- æŒç»­ç›‘æ§ç­–ç•¥è¡¨ç°ï¼ŒåŠæ—¶è°ƒæ•´
- å¸‚åœºç¯å¢ƒå˜åŒ–æ—¶é‡æ–°è¯„ä¼°ç­–ç•¥æœ‰æ•ˆæ€§

ã€æµç¨‹å®Œæˆã€‘ï¼šé‡åŒ–åˆ†æå’Œå®¡è®¡å·²å®Œæˆ
"""
    
    return {
        "messages": messages + [AIMessage(content=audit_report, name="Quant_Auditor")]
    }
