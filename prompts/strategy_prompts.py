"""
ç­–ç•¥ Prompt æ¨¡æ¿ä¸æ„å»ºå‡½æ•°
ä¾› AI ç­–ç•¥å†³ç­–ï¼ˆå•æ ‡çš„/ç»„åˆï¼‰ä½¿ç”¨ã€‚
"""
from __future__ import annotations


# ==================== ç­–ç•¥ä¸“å± Prompt æ¨¡æ¿ ====================

STRATEGY_PROMPTS = {
    "trend": {
        "name": "è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥",
        "philosophy": "é¡ºåŠ¿è€Œä¸ºï¼Œè¿½éšè¶‹åŠ¿",
        "key_indicators": ["å‡çº¿ç³»ç»Ÿ", "MACDåŠ¨é‡", "ä»·æ ¼çªç ´"],
        "buy_criteria": """
ã€ä¹°å…¥ä¿¡å·ã€‘- è¶‹åŠ¿å½¢æˆæ—¶å…¥åœºï¼š
1. **å‡çº¿å¤šå¤´æ’åˆ—**ï¼šMA5 > MA10 > MA20 > MA60ï¼ˆå¼ºè¶‹åŠ¿ç¡®è®¤ï¼‰
2. **MACDé‡‘å‰**ï¼šMACDæŸ±çŠ¶å›¾ > 0ï¼ŒåŠ¨é‡å‘ä¸Š
3. **ä»·æ ¼çªç ´**ï¼šä»·æ ¼ç«™ä¸ŠMA20ï¼Œçªç ´å‰æœŸé«˜ç‚¹
4. RSIåœ¨40-70åŒºé—´ï¼Œæœ‰ä¸Šæ¶¨åŠ¨èƒ½ä½†æœªè¿‡çƒ­
5. æˆäº¤é‡æ”¾å¤§ç¡®è®¤è¶‹åŠ¿

âš ï¸ è¶‹åŠ¿ç­–ç•¥ä¸è¿½æ±‚ä¹°åœ¨æœ€ä½ç‚¹ï¼Œè€Œæ˜¯ç¡®è®¤è¶‹åŠ¿åå…¥åœº
""",
        "sell_criteria": """
ã€å–å‡ºä¿¡å·ã€‘- è¶‹åŠ¿æ”¹å˜æ—¶ç¦»åœºï¼š
1. **å‡çº¿æ­»å‰**ï¼šMA5 < MA10ï¼ŒçŸ­æœŸè¶‹åŠ¿è½¬å¼±
2. **MACDæ­»å‰**ï¼šMACDæŸ±çŠ¶å›¾è½¬è´Ÿï¼ŒåŠ¨é‡è¡°å‡
3. **è·Œç ´æ”¯æ’‘**ï¼šä»·æ ¼è·Œç ´MA20
4. æ­¢æŸè§¦å‘ï¼šäºæŸè¾¾åˆ°æ­¢æŸçº¿
5. ç§»åŠ¨æ­¢ç›ˆï¼šä»æœ€é«˜ç‚¹å›æ’¤è¶…è¿‡é˜ˆå€¼

âš ï¸ RSIè¶…ä¹°(>70)åœ¨è¶‹åŠ¿ä¸­ä¸æ˜¯å–å‡ºä¿¡å·ï¼Œè¶‹åŠ¿å¯èƒ½ç»§ç»­
""",
        "hold_criteria": """
ã€æŒæœ‰è§‚æœ›ã€‘ï¼š
- è¶‹åŠ¿å»¶ç»­ä¸­ï¼Œç»§ç»­æŒæœ‰
- æ— æ˜ç¡®è¶‹åŠ¿æ—¶ï¼Œè€å¿ƒç­‰å¾…ä¿¡å·
"""
    },
    "mean_reversion": {
        "name": "å‡å€¼å›å½’ç­–ç•¥",
        "philosophy": "ä½ä¹°é«˜å–ï¼Œé€†å‘æŠ•èµ„",
        "key_indicators": ["RSIè¶…ä¹°è¶…å–", "å¸ƒæ—å¸¦", "ä»·æ ¼åç¦»åº¦"],
        "buy_criteria": """
ã€ä¹°å…¥ä¿¡å·ã€‘- è¶…å–æ—¶æŠ„åº•ï¼š
1. **RSIè¶…å–**ï¼šRSI < 30ï¼Œå¸‚åœºè¿‡åº¦æ‚²è§‚
2. **å¸ƒæ—å¸¦ä¸‹è½¨**ï¼šä»·æ ¼è§¦åŠæˆ–è·Œç ´å¸ƒæ—å¸¦ä¸‹è½¨
3. **å‡å€¼åç¦»**ï¼šä»·æ ¼å¤§å¹…ä½äºMA20ï¼ˆåç¦»>5%ï¼‰
4. å‡ºç°æ­¢è·Œä¿¡å·ï¼šKçº¿ä¼ç¨³ã€æˆäº¤é‡èç¼©
5. MACDåº•èƒŒç¦»ï¼šä»·æ ¼æ–°ä½ä½†MACDæœªæ–°ä½

âš ï¸ ä¸è¦åœ¨ä¸‹è·Œè¶‹åŠ¿ä¸­ç›²ç›®æŠ„åº•ï¼Œéœ€ç­‰å¾…ä¼ç¨³ä¿¡å·
""",
        "sell_criteria": """
ã€å–å‡ºä¿¡å·ã€‘- å›å½’å‡å€¼åè·åˆ©äº†ç»“ï¼š
1. **RSIè¶…ä¹°**ï¼šRSI > 70ï¼Œå¸‚åœºè¿‡åº¦ä¹è§‚
2. **å¸ƒæ—å¸¦ä¸Šè½¨**ï¼šä»·æ ¼è§¦åŠå¸ƒæ—å¸¦ä¸Šè½¨
3. **å›å½’å‡å€¼**ï¼šä»·æ ¼å›åˆ°MA20é™„è¿‘
4. è¾¾åˆ°ç›®æ ‡æ”¶ç›Š
5. æ­¢æŸè§¦å‘ï¼šå‡å€¼å›å½’å¤±è´¥ï¼Œç»§ç»­ä¸‹è·Œ

âš ï¸ å‡å€¼å›å½’ç­–ç•¥è¿½æ±‚å¿«è¿›å¿«å‡ºï¼Œä¸æ‹æˆ˜
""",
        "hold_criteria": """
ã€æŒæœ‰è§‚æœ›ã€‘ï¼š
- ä»·æ ¼åœ¨å¸ƒæ—å¸¦ä¸­è½¨é™„è¿‘ï¼Œæ— äº¤æ˜“æœºä¼š
- RSIåœ¨40-60æ­£å¸¸åŒºé—´ï¼Œç­‰å¾…æç«¯å€¼å‡ºç°
"""
    },
    "adaptive": {
        "name": "è‡ªé€‚åº”ç­–ç•¥",
        "philosophy": "æ ¹æ®å¸‚åœºçŠ¶æ€è‡ªåŠ¨åˆ‡æ¢ç­–ç•¥",
        "key_indicators": ["å¸‚åœºæ³¢åŠ¨ç‡", "è¶‹åŠ¿å¼ºåº¦", "ç»¼åˆæŒ‡æ ‡"],
        "buy_criteria": """
ã€ä¹°å…¥ä¿¡å·ã€‘- ç»¼åˆå¤šç§å› ç´ åˆ¤æ–­ï¼š
1. **è¶‹åŠ¿å¸‚åœº**ï¼šæŒ‰è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥ï¼Œå‡çº¿å¤šå¤´+MACDé‡‘å‰
2. **éœ‡è¡å¸‚åœº**ï¼šæŒ‰å‡å€¼å›å½’ç­–ç•¥ï¼ŒRSIè¶…å–+è§¦åŠä¸‹è½¨
3. **é«˜æ³¢åŠ¨å¸‚åœº**ï¼šè°¨æ…å…¥åœºï¼Œç­‰å¾…æ³¢åŠ¨æ”¶æ•›
4. å¤šæŒ‡æ ‡å…±æŒ¯ï¼šè‡³å°‘3ä¸ªæŒ‡æ ‡åŒæ—¶çœ‹å¤š
5. æˆäº¤é‡é…åˆç¡®è®¤

âš ï¸ è‡ªé€‚åº”ç­–ç•¥éœ€è¦ç»¼åˆåˆ¤æ–­å½“å‰å¸‚åœºçŠ¶æ€
""",
        "sell_criteria": """
ã€å–å‡ºä¿¡å·ã€‘- çµæ´»åº”å¯¹ï¼š
1. **è¶‹åŠ¿å¸‚åœº**ï¼šè¶‹åŠ¿åè½¬ä¿¡å·ï¼ˆå‡çº¿æ­»å‰ã€MACDæ­»å‰ï¼‰
2. **éœ‡è¡å¸‚åœº**ï¼šRSIè¶…ä¹°æˆ–è§¦åŠå¸ƒæ—å¸¦ä¸Šè½¨
3. æ­¢æŸæ­¢ç›ˆè§¦å‘
4. å¸‚åœºçŠ¶æ€çªå˜ï¼Œé£é™©ä¸Šå‡
5. æŒæœ‰æ—¶é—´è¿‡é•¿ï¼Œæ— æ˜ç¡®æ–¹å‘

âš ï¸ å¿«é€Ÿå“åº”å¸‚åœºå˜åŒ–ï¼Œçµæ´»è°ƒæ•´
""",
        "hold_criteria": """
ã€æŒæœ‰è§‚æœ›ã€‘ï¼š
- å¸‚åœºä¿¡å·æ··ä¹±ï¼Œå¤šç©ºä¸æ˜
- ç­‰å¾…æ›´æ¸…æ™°çš„å…¥åœºæ—¶æœº
"""
    },
    "chanlun": {
        "name": "ç¼ è®ºç­–ç•¥",
        "philosophy": "èµ°åŠ¿ç»ˆå®Œç¾ã€ç»“æ„é€’å½’ã€èƒŒé©°ä¸ä¸‰ç±»ä¹°å–ç‚¹",
        "key_indicators": ["åˆ†å‹ä¸ç¬”", "ä¸­æ¢", "MACDèƒŒé©°", "ä¸‰ç±»ä¹°å–ç‚¹"],
        "buy_criteria": """
ã€ä¹°å…¥ä¿¡å·ã€‘- ç¼ è®ºä¸‰ç±»ä¹°ç‚¹ï¼š
1. **ä¸€ä¹°ï¼ˆèƒŒé©°ï¼‰**ï¼šä¸‹è·Œè¶‹åŠ¿æœ«ç«¯ï¼Œä»·æ ¼åˆ›æ–°ä½ä½†MACDç»¿æŸ±/é¢ç§¯æœªåˆ›æ–°ä½ï¼ˆåº•èƒŒé©°ï¼‰
2. **äºŒä¹°**ï¼šä¸€ä¹°åé¦–æ¬¡å›è¸©ä¸ç ´å‰ä½ï¼Œç¡®è®¤è¶‹åŠ¿åè½¬
3. **ä¸‰ä¹°**ï¼šä¸­æ¢çªç ´åå›è¸©ä¸ç ´ä¸­æ¢ä¸Šæ²¿ï¼Œè¶‹åŠ¿åŠ é€Ÿ
4. åŒºé—´å¥—ï¼šå¤§çº§åˆ«å®šæ–¹å‘ã€å°çº§åˆ«æ‰¾ä¹°ç‚¹

âš ï¸ ç¼ è®ºå¼ºè°ƒâ€œä¸æµ‹è€Œæµ‹â€ï¼Œä¹°ç‚¹éœ€ç»“æ„+èƒŒé©°å…±æŒ¯
""",
        "sell_criteria": """
ã€å–å‡ºä¿¡å·ã€‘- ç¼ è®ºä¸‰ç±»å–ç‚¹ä¸èƒŒé©°ç¦»åœºï¼š
1. **ä¸€å–ï¼ˆé¡¶èƒŒé©°ï¼‰**ï¼šä¸Šæ¶¨è¶‹åŠ¿æœ«ç«¯ï¼Œä»·æ ¼åˆ›æ–°é«˜ä½†MACDçº¢æŸ±/é¢ç§¯æœªåˆ›æ–°é«˜
2. **äºŒå–**ï¼šä¸€å–ååå¼¹ä¸ç ´å‰é«˜
3. **ä¸‰å–**ï¼šä¸­æ¢è·Œç ´ååæŠ½ä¸ç ´ä¸­æ¢ä¸‹æ²¿
4. æ­¢æŸæ­¢ç›ˆè§¦å‘ï¼›ç§»åŠ¨æ­¢ç›ˆå›æ’¤

âš ï¸ é¡¶èƒŒé©°æ˜¯ç¦»åœºçš„é‡è¦ä¿¡å·ï¼Œä¸è´ªæœ€åä¸€ç¬”
""",
        "hold_criteria": """
ã€æŒæœ‰è§‚æœ›ã€‘ï¼š
- å½“å‰ç¬”/çº¿æ®µæœªå®Œæˆï¼Œæ— æ˜ç¡®ä¹°å–ç‚¹
- ä¸­æ¢éœ‡è¡ä¸­ï¼Œç­‰å¾…çªç ´æˆ–èƒŒé©°
- å¤šçº§åˆ«è”ç«‹æœªå…±æŒ¯
"""
    }
}


# ==================== é«˜èƒœç‡æ¨¡å¼è¿‡æ»¤ ====================

def _filter_by_high_win_rate_rules(stocks_data: list, positions: dict) -> list:
    """
    é«˜èƒœç‡æ¨¡å¼é¢„è¿‡æ»¤ï¼šåœ¨è°ƒç”¨LLMå‰å…ˆç”¨è§„åˆ™è¿‡æ»¤æ‰æ˜æ˜¾ä¸ç¬¦åˆæ¡ä»¶çš„ä¹°å…¥æœºä¼šã€‚
    """
    filtered = []
    for s in stocks_data:
        ind = s['indicators']
        code = s['code']
        if s['has_position']:
            filtered.append(s)
            continue
        price = ind.get('close', ind.get('Current_Price', 0))
        ma5 = ind.get('MA5', price)
        ma10 = ind.get('MA10', price)
        ma20 = ind.get('MA20', price)
        ma60 = ind.get('MA60', ma20)
        rsi = ind.get('RSI', 50)
        macd_hist = ind.get('MACD_Hist', 0)
        bullish_count = 0
        if ma5 > ma10 > ma20:
            bullish_count += 1
        if price > ma60:
            bullish_count += 1
        if 35 <= rsi <= 65:
            bullish_count += 1
        elif 30 <= rsi <= 70:
            bullish_count += 0.5
        if macd_hist > 0:
            bullish_count += 1
        price_vs_ma20 = (price - ma20) / ma20 if ma20 > 0 else 0
        if price_vs_ma20 <= 0.05:
            bullish_count += 1
        s['high_win_rate_score'] = bullish_count
        s['high_win_rate_qualified'] = bullish_count >= 2.5
        filtered.append(s)
    return filtered


# ==================== ç»„åˆå†³ç­– Prompt æ„å»º ====================

def build_portfolio_decision_prompt(
    stocks_data: list,
    positions: dict,
    cash: float,
    total_value: float,
    strategy_type: str,
    risk_preference: str,
    max_positions: int = 5,
    high_win_rate_mode: bool = False,
    market_context: dict = None,
    pool_mode: str = None,
    stock_industry_map: dict = None,
) -> str:
    """æ„å»ºé€‰è‚¡æ± ç»„åˆå†³ç­–çš„ LLM Promptã€‚"""
    strategy_prompt = STRATEGY_PROMPTS.get(strategy_type, STRATEGY_PROMPTS['adaptive'])
    risk_config = {
        'aggressive': {'max_single_position': 0.35, 'min_cash_ratio': 0.1, 'desc': 'æ¿€è¿›æ¨¡å¼ï¼šè¿½æ±‚æ”¶ç›Šæœ€å¤§åŒ–'},
        'balanced': {'max_single_position': 0.25, 'min_cash_ratio': 0.2, 'desc': 'å‡è¡¡æ¨¡å¼ï¼šæ”¶ç›Šä¸é£é™©å¹³è¡¡'},
        'conservative': {'max_single_position': 0.15, 'min_cash_ratio': 0.3, 'desc': 'ä¿å®ˆæ¨¡å¼ï¼šæœ¬é‡‘å®‰å…¨ä¼˜å…ˆ'}
    }
    risk_cfg = risk_config.get(risk_preference, risk_config['balanced'])

    def _safe_float(v, default=0.0):
        if v is None:
            return default
        try:
            f = float(v)
            return default if (f != f or f == float('inf') or f == float('-inf')) else f
        except (TypeError, ValueError):
            return default

    stocks_table = []
    for s in stocks_data:
        ind = s['indicators']
        price = _safe_float(ind.get('close') or ind.get('æ”¶ç›˜') or ind.get('Current_Price'), 0.0)
        if price <= 0 and ind.get('close') is None and ind.get('æ”¶ç›˜') is None:
            price = _safe_float(ind.get('Close'), 0.0)
        ma5 = _safe_float(ind.get('MA5'), price if price > 0 else 0)
        ma10 = _safe_float(ind.get('MA10'), ma5)
        ma20 = _safe_float(ind.get('MA20'), ma10)
        rsi = _safe_float(ind.get('RSI'), 50.0)
        macd_hist = _safe_float(ind.get('MACD_Hist'), 0.0)
        bb_upper = _safe_float(ind.get('BB_Upper'), price * 1.1 if price > 0 else 0)
        bb_lower = _safe_float(ind.get('BB_Lower'), price * 0.9 if price > 0 else 0)
        if ma5 > ma10 > ma20:
            ma_state = "å¤šå¤´â†‘"
        elif ma5 < ma10 < ma20:
            ma_state = "ç©ºå¤´â†“"
        else:
            ma_state = "éœ‡è¡â—‹"
        if rsi > 70:
            rsi_state = "è¶…ä¹°ğŸ”´"
        elif rsi < 30:
            rsi_state = "è¶…å–ğŸŸ¢"
        else:
            rsi_state = "æ­£å¸¸âšª"
        bb_pos = ((price - bb_lower) / (bb_upper - bb_lower) * 100) if (bb_upper - bb_lower) > 0 else 50
        profit_pct_val = _safe_float(s.get('profit_pct'), 0.0)
        if s['has_position']:
            pos_info = f"æŒä»“{s.get('holding_days', 0)}å¤©|ç›ˆäº{profit_pct_val:+.1f}%"
        else:
            pos_info = "ç©ºä»“"
        industry_name = (s.get('industry') or (stock_industry_map or {}).get(s['code'], '')) if (pool_mode == 'industry' and stock_industry_map) else ''
        row = {
            'code': s['code'],
            'price': price,
            'ma_state': ma_state,
            'rsi': rsi,
            'rsi_state': rsi_state,
            'macd': 'é‡‘å‰ğŸ“ˆ' if macd_hist > 0 else 'æ­»å‰ğŸ“‰',
            'bb_pos': bb_pos,
            'pos_info': pos_info,
            'profit_pct': profit_pct_val,
            'has_position': s['has_position']
        }
        if pool_mode == 'industry' and stock_industry_map:
            row['industry'] = industry_name
        stocks_table.append(row)

    current_positions = [s for s in stocks_table if s['has_position']]
    position_count = len(current_positions)
    cash_ratio = (cash / total_value * 100) if total_value > 0 else 100
    industry_mode_note = ''
    if pool_mode == 'industry' and stock_industry_map:
        industry_mode_note = '\n**å½“å‰é€‰è‚¡æ± ä¸ºåˆ†è¡Œä¸šé¾™å¤´æ¨¡å¼**ï¼Œæ¯åªè‚¡ç¥¨å·²æ ‡æ³¨æ‰€å±è¡Œä¸šï¼Œè¯·è€ƒè™‘è¡Œä¸šåˆ†æ•£ä¸è¡Œä¸šè½®åŠ¨åšå‡ºå†³ç­–ã€‚\n'
    prompt = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„Aè‚¡ç»„åˆæŠ•èµ„ç»ç†ï¼Œè¯·ç»¼åˆåˆ†æé€‰è‚¡æ± ä¸­æ‰€æœ‰è‚¡ç¥¨çš„è¡¨ç°ï¼Œç»“åˆAè‚¡å¸‚åœºç¯å¢ƒï¼ˆæˆäº¤é‡ã€åŒ—å‘èµ„é‡‘ç­‰ï¼‰åˆ¤æ–­è¶‹åŠ¿ï¼Œä¸ºæ•´ä¸ªæŠ•èµ„ç»„åˆåšå‡ºæœ€ä¼˜å†³ç­–ã€‚
{industry_mode_note}
**è¯´æ˜**ï¼šä»¥ä¸‹è‚¡ç¥¨æ•°æ®å‡ä¸ºå½“æ—¥æˆªé¢æ•°æ®ï¼ˆä»·æ ¼ã€å‡çº¿ã€RSIã€MACDã€å¸ƒæ—å¸¦ç­‰ï¼‰ï¼Œæ•°æ®å·²æ ¡éªŒå¯ç”¨ã€‚è¯·ç›´æ¥åŸºäºæŠ€æœ¯é¢ä¸æŒä»“åšå†³ç­–ï¼›analysis ä¸­è¯·å‹¿è¾“å‡ºã€Œå¸‚åœºæ•°æ®å¼‚å¸¸ã€ã€Œæ•°æ®å¼‚å¸¸ã€ç­‰è¡¨è¿°ï¼Œä»…ç»™å‡ºå¯¹å¤šç©ºä¸ä»“ä½çš„åˆ¤æ–­å³å¯ã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š è´¦æˆ·æ¦‚å†µ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- è´¦æˆ·æ€»å¸‚å€¼ï¼šÂ¥{total_value:,.0f}
- å¯ç”¨ç°é‡‘ï¼šÂ¥{cash:,.0f} ({cash_ratio:.1f}%)
- å½“å‰æŒä»“æ•°ï¼š{position_count}/{max_positions}åª
- ç­–ç•¥ç±»å‹ï¼š{strategy_prompt['name']}ï¼ˆ{strategy_prompt['philosophy']}ï¼‰
- é£é™©åå¥½ï¼š{risk_cfg['desc']}
- å•è‚¡æœ€å¤§ä»“ä½ï¼š{risk_cfg['max_single_position']*100:.0f}%
- æœ€ä½ç°é‡‘ä¿ç•™ï¼š{risk_cfg['min_cash_ratio']*100:.0f}%
"""
    summary = (market_context or {}).get('summary') or ''
    if summary and 'å¼‚å¸¸' not in summary and 'æš‚ä¸å¯ç”¨' not in summary and 'ç¼ºå¤±' not in summary:
        prompt += f"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸŒ Aè‚¡å¸‚åœºç¯å¢ƒï¼ˆè¯·ç»“åˆæ­¤åˆ¤æ–­å¤§ç›˜è¶‹åŠ¿ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{summary}
- åŒ—å‘èµ„é‡‘å‡€æµå…¥ä¸ºæ­£è¡¨ç¤ºå¤–èµ„æµå…¥ã€åå¤šï¼›æŒç»­å‡€æµå‡ºéœ€è°¨æ…ã€‚
- å¤§ç›˜æˆäº¤é‡æ”¾å¤§ä¸”ä¸Šæ¶¨è¡¨ç¤ºé‡ä»·é…åˆï¼›ç¼©é‡åå¼¹éœ€è°¨æ…ã€‚
è¯·åŸºäºä¸Šè¿°å¸‚åœºç¯å¢ƒï¼Œåˆ¤æ–­å½“å‰æ˜¯åå¤šã€åç©ºè¿˜æ˜¯éœ‡è¡ï¼Œå¹¶æ®æ­¤è°ƒæ•´ä¹°å…¥/å‡ä»“åŠ›åº¦ã€‚
"""
    else:
        prompt += """
**è¯´æ˜**ï¼šå½“æ—¥æœªæä¾›åŒ—å‘/å¤§ç›˜ç¯å¢ƒæ•°æ®ï¼Œè¯·ä»…åŸºäºä¸‹æ–¹è‚¡ç¥¨æ•°æ®ä¸æŒä»“åšå†³ç­–ï¼Œå‹¿åœ¨ analysis ä¸­æåŠã€Œæ•°æ®å¼‚å¸¸ã€ã€Œæ•°æ®ç¼ºå¤±ã€ã€‚
"""
    prompt += f"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ˆ è‚¡ç¥¨æ± æ•°æ®ï¼ˆ{len(stocks_table)}åªè‚¡ç¥¨ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    for s in stocks_table:
        industry_line = f"  è¡Œä¸š: {s.get('industry', '')}\n" if s.get('industry') else ""
        prompt += f"""
ã€{s['code']}ã€‘ä»·æ ¼Â¥{s['price']:.2f}
{industry_line}  æŠ€æœ¯é¢: å‡çº¿{s['ma_state']} | RSI {s['rsi']:.0f}{s['rsi_state']} | MACD{s['macd']} | å¸ƒæ—{s['bb_pos']:.0f}%
  æŒä»“çŠ¶æ€: {s['pos_info']}
"""
    if current_positions:
        prompt += f"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ å½“å‰æŒä»“è¯¦æƒ…
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
        total_profit = 0
        for pos in current_positions:
            prompt += f"- {pos['code']}: ç›ˆäº {pos['profit_pct']:+.1f}%\n"
            total_profit += pos['profit_pct']
        avg_profit = total_profit / len(current_positions) if current_positions else 0
        prompt += f"- ç»„åˆå¹³å‡ç›ˆäºï¼š{avg_profit:+.1f}%\n"
    high_win_rate_rules = ""
    if high_win_rate_mode:
        high_win_rate_rules = """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ é«˜èƒœç‡æ¨¡å¼ï¼ˆä¸¥æ ¼è¿‡æ»¤ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
**ä¹°å…¥æ¡ä»¶å¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹è‡³å°‘3é¡¹ï¼š**
1. å‡çº¿å¤šå¤´æ’åˆ—ï¼ˆMA5>MA10>MA20ï¼‰
2. RSIåœ¨40-65åŒºé—´ï¼ˆä¸è¿½æ¶¨ä¸æŠ„åº•ï¼‰
3. MACDé‡‘å‰æˆ–æŸ±çŠ¶å›¾è¿ç»­æ”¾å¤§
4. ä»·æ ¼åœ¨å¸ƒæ—å¸¦ä¸­è½¨ä»¥ä¸Š
5. é‡ä»·é…åˆï¼ˆä»·æ¶¨é‡å¢ï¼‰
6. ä»·æ ¼ä¸è¶…è¿‡MA20çš„5%ï¼ˆé¿å…è¿½é«˜ï¼‰

**å¿…é¡»ç¦æ­¢ä¹°å…¥çš„æƒ…å†µï¼š**
- RSIè¶…è¿‡70ï¼ˆè¶…ä¹°ï¼‰
- ä»·æ ¼å¤§å¹…åç¦»å‡çº¿ï¼ˆè¿½æ¶¨å«Œç–‘ï¼‰
- MACDæ­»å‰
- è¿ç»­ä¸‹è·Œä¸­

**æ­¢ç›ˆæ­¢æŸè§„åˆ™ï¼š**
- æ­¢æŸï¼šè·Œç ´ä¹°å…¥ä»·3%ç«‹å³æ­¢æŸ
- æ­¢ç›ˆï¼šè¾¾åˆ°6%ç›ˆåˆ©æ—¶æ­¢ç›ˆï¼ˆ2:1ç›ˆäºæ¯”ï¼‰
- ç§»åŠ¨æ­¢æŸï¼šæœ€é«˜ä»·å›æ’¤2.5%æ­¢ç›ˆ

**è¦æ±‚confidenceè‡³å°‘0.70æ‰èƒ½ä¹°å…¥**
"""
    prompt += f"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ äº¤æ˜“è§„åˆ™ï¼ˆ{strategy_prompt['name']}ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{strategy_prompt['buy_criteria']}
{strategy_prompt['sell_criteria']}
{high_win_rate_rules}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ å†³ç­–ä»»åŠ¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¯·ç»¼åˆåˆ†ææ‰€æœ‰è‚¡ç¥¨çš„æŠ€æœ¯é¢å’Œå½“å‰æŒä»“ï¼Œç»™å‡ºæœ€ä¼˜çš„ç»„åˆè°ƒæ•´å»ºè®®ï¼š

1. **å“ªäº›æŒä»“åº”è¯¥å–å‡º**ï¼ˆæ­¢æŸ/æ­¢ç›ˆ/è¶‹åŠ¿è½¬å¼±ï¼‰
2. **å“ªäº›ç©ºä»“è‚¡ç¥¨å€¼å¾—ä¹°å…¥**ï¼ˆä¿¡å·æœ€å¼ºã€æ€§ä»·æ¯”æœ€é«˜ï¼‰
3. **èµ„é‡‘å¦‚ä½•åˆ†é…**ï¼ˆè€ƒè™‘é£é™©åˆ†æ•£ï¼‰ï¼š**å¯¹äºè¡¨ç°å¥½ã€ä¿¡å·å¼ºçš„è‚¡ç¥¨å¯æé«˜ä»“ä½**ï¼›å¯¹é«˜confidenceçš„æ ‡çš„å¯ç»™äºˆæ›´é«˜ä»“ä½ï¼Œå¯¹è¡¨ç°ä¸€èˆ¬æˆ–ä¸ç¡®å®šæ€§é«˜çš„ç»™äºˆè¾ƒä½ä»“ä½ã€‚

**è¾“å‡ºJSONæ ¼å¼**ï¼š
{{
    "analysis": "50å­—ä»¥å†…çš„æ•´ä½“å¸‚åœºåˆ¤æ–­",
    "decisions": [
        {{"code": "è‚¡ç¥¨ä»£ç ", "action": "BUY/SELL/HOLD", "confidence": 0.6-0.95, "reason": "å†³ç­–ç†ç”±30å­—å†…"}}
    ],
    "priority_buy": ["å»ºè®®ä¼˜å…ˆä¹°å…¥çš„è‚¡ç¥¨ä»£ç ï¼ŒæŒ‰ä¿¡å·å¼ºåº¦æ’åº"],
    "priority_sell": ["å»ºè®®ä¼˜å…ˆå–å‡ºçš„è‚¡ç¥¨ä»£ç ï¼ŒæŒ‰ç´§è¿«æ€§æ’åº"]
}}

**confidence å»ºè®®åŒºé—´**ï¼ˆä¸¥æ ¼åŒºåˆ†å¼ºå¼±ï¼Œä¾¿äºç³»ç»ŸæŒ‰æ¯”ä¾‹åˆ†é…ä»“ä½ï¼‰ï¼š
- è¡¨ç°å¥½ã€è¶‹åŠ¿æ˜ç¡®ã€ä¿¡å·éå¸¸ç¡®å®šï¼šconfidence 0.80â€“0.95
- è¡¨ç°ä¸€èˆ¬ã€æœ‰ä¸ç¡®å®šæ€§ï¼šconfidence 0.60â€“0.70
- ä¸å»ºè®®ä¹°æˆ–è§‚æœ›ï¼šconfidence 0.50 åŠä»¥ä¸‹æˆ– action=HOLD

**æ—¶é—´å› å­ä¸é¿å…é¢‘ç¹è°ƒä»“**ï¼š
- ä¸è¦è¿‡äºé¢‘ç¹è°ƒä»“ï¼Œä»¥å…äº§ç”Ÿæ‘©æ“¦æˆæœ¬å’Œç£¨æŸã€‚æŒä»“æ—¶é—´è¾ƒçŸ­ï¼ˆå¦‚ä¸è¶³5å¤©ï¼‰ä¸”è¶‹åŠ¿æœªç ´åã€æœªè§¦å‘æ­¢æŸæ—¶ï¼Œ**å€¾å‘ç»§ç»­æŒæœ‰**ï¼Œä¸è¦è½»æ˜“ç»™å‡º SELLã€‚
- æ–°å»ºä»“çš„æ ‡çš„å»ºè®®è‡³å°‘æŒæœ‰æ•°æ—¥å†è¯„ä¼°æ˜¯å¦å–å‡ºï¼›ä»…å½“æ˜ç¡®æ­¢æŸï¼ˆå¦‚è·Œç ´æˆæœ¬çº¦3%ï¼‰ã€æˆ–è¶‹åŠ¿æ˜æ˜¾ç ´åæ—¶ï¼Œæ‰åœ¨çŸ­æœŸæŒä»“å†…å»ºè®®å–å‡ºã€‚
- å–å‡ºå»ºè®®åº”ä¼˜å…ˆç»™ï¼šæŒä»“è¾ƒä¹…ä¸”è¶‹åŠ¿è½¬å¼±ã€æˆ–å·²è¾¾æ­¢ç›ˆ/æ­¢æŸçš„æ ‡çš„ã€‚

æ³¨æ„ï¼š
1. decisionså¿…é¡»åŒ…å«æ‰€æœ‰{len(stocks_table)}åªè‚¡ç¥¨çš„å†³ç­–
2. ä¹°å…¥å†³ç­–éœ€è€ƒè™‘ç°é‡‘æ˜¯å¦å……è¶³ã€æ˜¯å¦å·²è¾¾æœ€å¤§æŒä»“æ•°
3. å–å‡ºå†³ç­–éœ€è€ƒè™‘æ­¢æŸæ­¢ç›ˆã€è¶‹åŠ¿è½¬å¼±ç­‰å› ç´ ï¼Œå¹¶è€ƒè™‘æŒä»“å¤©æ•°ï¼ˆçŸ­æœŸæŒä»“éæ­¢æŸä¸å–ï¼‰
4. ç›¸åŒä¿¡å·å¼ºåº¦æ—¶ï¼Œä¼˜å…ˆé€‰æ‹©ç›ˆåˆ©ç¡®å®šæ€§æ›´é«˜çš„è‚¡ç¥¨
5. **ä¸è¦ä¹°çƒ‚è‚¡**ï¼šæŠ€æœ¯é¢å¼±ï¼ˆå‡çº¿ç©ºå¤´ã€RSIè¶…ä¹°ã€MACDæ­»å‰ï¼‰ã€è¶‹åŠ¿ä¸æ˜æˆ–é•¿æœŸè·‘è¾“å¤§ç›˜çš„æ ‡çš„ï¼Œä¸€å¾‹ä¸ä¹°æˆ–confidenceç»™ä½ï¼›å¯¹å†å²/æŒä»“æ”¶ç›Šç‡è¾ƒä½ã€è¡¨ç°å·®çš„è‚¡ç¥¨è¦æ›´è°¨æ…ï¼Œå®å¯å°‘ä¹°ä¹Ÿä¸è¿½å¼±åŠ¿è‚¡
6. ä¼˜å…ˆé€‰æ‹©ï¼šè´¨é‡é«˜ã€è¶‹åŠ¿æ˜ç¡®ã€é‡ä»·é…åˆã€ä¸å¤§ç›˜/åŒ—å‘èµ„é‡‘æ–¹å‘ä¸€è‡´çš„æ ‡çš„
7. **è¡¨ç°å¥½çš„å¯æé«˜ä»“ä½**ï¼šå¯¹æŠ€æœ¯é¢å¼ºã€è¶‹åŠ¿æ˜ç¡®ã€æŒä»“ç›ˆåˆ©æˆ–ä¿¡å·éå¸¸ç¡®å®šçš„è‚¡ç¥¨ï¼Œç»™å‡º confidence 0.80â€“0.95ï¼›è¡¨ç°ä¸€èˆ¬çš„ç»™ 0.60â€“0.70
{'8. ã€é«˜èƒœç‡æ¨¡å¼ã€‘ä¹°å…¥ä¿¡å·confidenceå¿…é¡»>=0.70ï¼Œä¸¥æ ¼æ‰§è¡Œå¤šæŒ‡æ ‡ç¡®è®¤' if high_win_rate_mode else ''}
"""
    return prompt


# ==================== å•æ ‡çš„ä¿¡å· Prompt æ„å»º ====================

def build_llm_signal_prompt(
    indicators: dict,
    strategy_type: str,
    risk_preference: str,
    has_position: bool,
    entry_price: float = None,
    holding_days: int = 0,
    highest_price: float = None,
) -> str:
    """æ ¹æ®ç­–ç•¥ç±»å‹æ„å»ºå•æ ‡çš„ LLM ä¿¡å· Promptã€‚"""
    from modules.strategy_config import get_strategy_config
    config = get_strategy_config(
        strategy_type if strategy_type != 'adaptive' else 'trend',
        risk_preference
    )
    strategy_prompt = STRATEGY_PROMPTS.get(strategy_type, STRATEGY_PROMPTS['trend'])
    price = indicators.get('close', indicators.get('Current_Price', 0))
    ma20 = indicators.get('MA20', price)
    bb_upper = indicators.get('BB_Upper', price * 1.1)
    bb_lower = indicators.get('BB_Lower', price * 0.9)
    bb_middle = indicators.get('BB_Middle', ma20)
    price_vs_ma20 = ((price - ma20) / ma20 * 100) if ma20 > 0 else 0
    bb_position = ((price - bb_lower) / (bb_upper - bb_lower) * 100) if (bb_upper - bb_lower) > 0 else 50
    position_info = ""
    if has_position and entry_price:
        profit_pct = ((price - entry_price) / entry_price * 100) if entry_price > 0 else 0
        max_profit = ((highest_price - entry_price) / entry_price * 100) if highest_price and entry_price > 0 else profit_pct
        display_highest = highest_price if highest_price else price
        position_info = f"""
**å½“å‰æŒä»“çŠ¶æ€**ï¼šæŒä»“ä¸­
- å¼€ä»“ä»·æ ¼ï¼šÂ¥{entry_price:.2f}
- å½“å‰ä»·æ ¼ï¼šÂ¥{price:.2f}
- å½“å‰ç›ˆäºï¼š{profit_pct:+.2f}%
- æŒä»“å¤©æ•°ï¼š{holding_days}å¤©
- æœŸé—´æœ€é«˜ä»·ï¼šÂ¥{display_highest:.2f}
- æœ€å¤§æµ®ç›ˆï¼š{max_profit:+.2f}%
- æ­¢æŸçº¿ï¼š{config.get('stop_loss_pct', 0.05)*100:.1f}%
- æ­¢ç›ˆçº¿ï¼š{config.get('take_profit_pct', 0.12)*100:.1f}%
"""
    else:
        position_info = "**å½“å‰æŒä»“çŠ¶æ€**ï¼šç©ºä»“"
    risk_notes = {
        'aggressive': "æ¿€è¿›æ¨¡å¼ï¼šå¯æ¥å—è¾ƒå¤§å›æ’¤ï¼Œè¿½æ±‚æ›´é«˜æ”¶ç›Šï¼Œä¿¡å·å¯é€‚å½“æ”¾å®½",
        'balanced': "å‡è¡¡æ¨¡å¼ï¼šå¹³è¡¡æ”¶ç›Šä¸é£é™©ï¼ŒæŒ‰æ ‡å‡†ä¿¡å·æ‰§è¡Œ",
        'conservative': "ä¿å®ˆæ¨¡å¼ï¼šä¿æœ¬ä¼˜å…ˆï¼Œä¿¡å·éœ€æ›´æ˜ç¡®ï¼Œä¸¥æ ¼æ­¢æŸ"
    }
    prompt = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„Aè‚¡é‡åŒ–äº¤æ˜“åˆ†æå¸ˆï¼Œè¯·æ ¹æ®ä»¥ä¸‹æŠ€æœ¯æŒ‡æ ‡æ•°æ®ï¼ŒæŒ‰ç…§ã€{strategy_prompt['name']}ã€‘çš„é€»è¾‘è¿›è¡Œåˆ†æã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š æŠ€æœ¯æŒ‡æ ‡æ•°æ®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ä»·æ ¼ä¿¡æ¯ï¼š
- å½“å‰ä»·æ ¼ï¼šÂ¥{price:.2f}
- ç›¸å¯¹MA20ï¼š{price_vs_ma20:+.2f}%ï¼ˆ{'é«˜äº' if price_vs_ma20 > 0 else 'ä½äº'}20æ—¥å‡çº¿ï¼‰
- å¸ƒæ—å¸¦ä½ç½®ï¼š{bb_position:.1f}%ï¼ˆ0=ä¸‹è½¨ï¼Œ50=ä¸­è½¨ï¼Œ100=ä¸Šè½¨ï¼‰

å‡çº¿ç³»ç»Ÿï¼š
- MA5ï¼šÂ¥{indicators.get('MA5', 0):.2f}
- MA10ï¼šÂ¥{indicators.get('MA10', 0):.2f}
- MA20ï¼šÂ¥{indicators.get('MA20', 0):.2f}
- MA60ï¼šÂ¥{indicators.get('MA60', indicators.get('MA20', 0)):.2f}
- å‡çº¿æ’åˆ—ï¼š{'å¤šå¤´æ’åˆ—âœ…' if indicators.get('MA5', 0) > indicators.get('MA10', 0) > indicators.get('MA20', 0) else 'ç©ºå¤´æ’åˆ—âŒ' if indicators.get('MA5', 0) < indicators.get('MA10', 0) < indicators.get('MA20', 0) else 'æ··ä¹±âš ï¸'}

åŠ¨é‡æŒ‡æ ‡ï¼š
- RSI(14)ï¼š{indicators.get('RSI', 50):.1f} {'ğŸ”´è¶…ä¹°' if indicators.get('RSI', 50) > 70 else 'ğŸŸ¢è¶…å–' if indicators.get('RSI', 50) < 30 else 'âšªæ­£å¸¸'}
- MACDæŸ±ï¼š{indicators.get('MACD_Hist', 0):.4f} {'ğŸ“ˆé‡‘å‰' if indicators.get('MACD_Hist', 0) > 0 else 'ğŸ“‰æ­»å‰'}

å¸ƒæ—å¸¦ï¼š
- ä¸Šè½¨ï¼šÂ¥{bb_upper:.2f}
- ä¸­è½¨ï¼šÂ¥{bb_middle:.2f}
- ä¸‹è½¨ï¼šÂ¥{bb_lower:.2f}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{position_info}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ç­–ç•¥é…ç½®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç­–ç•¥ç±»å‹ï¼š{strategy_prompt['name']}
æ ¸å¿ƒç†å¿µï¼š{strategy_prompt['philosophy']}
å…³é”®æŒ‡æ ‡ï¼š{', '.join(strategy_prompt['key_indicators'])}
é£é™©åå¥½ï¼š{risk_notes.get(risk_preference, risk_notes['balanced'])}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– äº¤æ˜“è§„åˆ™
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{strategy_prompt['buy_criteria']}

{strategy_prompt['sell_criteria']}

{strategy_prompt['hold_criteria']}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ ä½ çš„ä»»åŠ¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¯·ä¸¥æ ¼æŒ‰ç…§ã€{strategy_prompt['name']}ã€‘çš„é€»è¾‘åˆ†æå½“å‰å¸‚åœºï¼Œè¾“å‡ºäº¤æ˜“å†³ç­–ã€‚

**è¾“å‡ºJSONæ ¼å¼**ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
{{
    "action": "BUY" æˆ– "SELL" æˆ– "HOLD",
    "confidence": 0.5-0.95ä¹‹é—´çš„ä¿¡å¿ƒåº¦,
    "reasoning": "å†³ç­–ç†ç”±ï¼ˆå¿…é¡»ä½“ç°{strategy_prompt['name']}çš„é€»è¾‘ï¼Œè¯´æ˜å“ªäº›æŒ‡æ ‡æ”¯æŒè¯¥å†³ç­–ï¼‰"
}}

æ³¨æ„ï¼š
1. ä¿¡å¿ƒåº¦ä½äº0.6æ—¶åº”è¯¥é€‰æ‹©HOLD
2. å†³ç­–ç†ç”±å¿…é¡»å¼•ç”¨å…·ä½“çš„æŒ‡æ ‡æ•°å€¼
3. ç†ç”±è¦ç®€æ´ï¼Œä¸è¶…è¿‡100å­—
"""
    return prompt
