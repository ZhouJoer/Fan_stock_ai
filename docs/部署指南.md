# 部署指南

本文档说明如何在本机或 Docker 中部署股票多 Agent 分析系统。

## 环境要求

- Python 3.x（推荐 3.10）
- Node.js 16+
- DeepSeek API Key（在 `.env` 中配置 `DEEPSEEK_API_KEY`）

---

## 方式一：Docker 部署（推荐）

### 前置要求

- Docker Desktop（Windows/Mac）或 Docker Engine（Linux）
- Docker Compose

### 快速部署

**Windows**：
```bash
deploy.bat
```

**Linux/Mac**：
```bash
chmod +x deploy.sh
./deploy.sh
```

部署脚本会自动：检查 Docker 环境、从 `.env.example` 创建 `.env`、构建镜像、启动服务。

### 手动部署

```bash
# 1. 配置环境变量
cp .env.example .env
# 编辑 .env，设置 DEEPSEEK_API_KEY

# 2. 构建并启动
docker-compose up -d

# 3. 查看日志
docker-compose logs -f
```

### 访问地址

- 前端：http://localhost:5173
- 后端 API：http://localhost:8000
- 健康检查：http://localhost:8000/api/health

### 数据目录（卷挂载）

Docker 后端容器内的 `/app/data`、`/app/db`、`/app/pools` 通过卷挂载到**宿主机**。实际读写的是**运行 docker-compose 时所在的项目根目录**下的 `data/`、`db/`、`pools/` 三个文件夹；容器删除或重建后，这些目录中的数据仍会保留在宿主机上。

| 容器内路径   | 宿主机路径（项目根目录下） |
|-------------|----------------------------|
| `/app/data` | `./data`                   |
| `/app/db`   | `./db`                     |
| `/app/pools`| `./pools`                  |

### 中文字体

后端镜像已内置中文字体（fonts-wqy-microhei），组合回测、ETF 轮动等图表中文可正常显示；本地开发时 Windows/macOS 使用系统字体。

### 常用命令

```bash
# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
docker-compose logs -f frontend
```

### 绿联 NAS（arm64/rk3588）部署

在 arm64 架构的 NAS 上，请使用 NAS 专用配置指定平台：

```bash
docker compose -f docker-compose.yml -f docker-compose.nas.yml build
docker compose -f docker-compose.yml -f docker-compose.nas.yml up -d
```

---

## 方式二：虚拟环境部署（开发环境）

### Windows（推荐 PowerShell）

```powershell
# 1. 设置虚拟环境（UTF-8 编码脚本）
.\setup_venv.ps1

# 若遇执行策略限制，可运行：
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
# 或
powershell -ExecutionPolicy Bypass -File .\setup_venv.ps1

# 2. 激活虚拟环境
.\venv\Scripts\Activate.ps1

# 3. 安装前端依赖（首次）
npm run install:web

# 4. 启动服务
npm run api   # 后端
npm run dev   # 前端（新终端）
```

### Windows（传统批处理）

```bash
setup_venv.bat
venv\Scripts\activate
npm run install:web
npm run api    # 后端
npm run dev    # 前端（新终端）
```

### Linux/Mac

```bash
chmod +x setup_venv.sh
./setup_venv.sh
source venv/bin/activate
npm run install:web
npm run api    # 后端
npm run dev    # 前端（新终端）
```

---

## 方式三：手动安装（传统方式）

### 后端依赖

```bash
python -m pip install -r requirements.txt
# 或：pip install -r requirements.txt（推荐使用 Python 3.10）
```

主要依赖：langchain / langgraph、langchain-community / langchain-huggingface、akshare、fastapi / uvicorn、faiss-cpu、sentence-transformers、pypdf、ta 等。

### 前端依赖

```bash
# 从项目根目录
npm run install:web

# 或进入 web 目录
cd web && npm install
```

### 环境变量

创建 `.env`（可从 `.env.example` 复制），至少配置：

```env
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
```

多用户模式等详见项目根目录 `.env.example` 注释；修改 `.env` 后需重启后端。

### 启动服务

```bash
# 后端（终端 1）
python -m uvicorn api_server:app --host 127.0.0.1 --port 8000 --reload

# 或使用 npm 脚本
npm run api

# 前端（终端 2，首次请先执行 npm run install:web）
npm run dev
```

访问：http://localhost:5173

---

## 端口说明

- 后端默认：8000
- 前端开发：5173；Docker 生产：80

如端口被占用，可修改 `docker-compose.yml` 中的端口映射或 uvicorn/vite 的启动参数。
