# ETF 轮动策略交易逻辑文档

本篇文档从**策略与实现细节**的角度说明 ETF 轮动模块的核心逻辑，包括轮动触发条件、仓位与交易计算方式，以及若干典型场景示例。界面操作与模拟盘使用请参考 [ETF轮动前端与模拟盘.md](ETF轮动前端与模拟盘.md)。

从概念上，**ETF 轮动可以说是挖掘因子轮动的某种特化场景**（在固定 ETF 池上按技术指标得分做轮动）；本文聚焦该特化场景的策略与实现。

---

## 一、整体架构与工作流

### 1.1 策略框架概览

ETF 轮动策略通过定期评估 ETF 池中所有 ETF 的技术指标得分，选择得分最高的 Top-K 只 ETF 进行持仓，并按设定的轮动间隔与再平衡规则调整仓位。

```
┌──────────────────────────────────────────────────────────────┐
│                 ETF 池 (etf_codes)                           │
│  510300, 510500, 159915, ...                                 │
└──────────────────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────┐
│       技术指标与得分计算 (tools/etf_rotation.py)             │
│  - 动量（收益率）                                            │
│  - RSI                                                       │
│  - 均线（MA）                                               │
│  - MACD                                                     │
│  → 汇总为每只 ETF 的综合得分                               │
└──────────────────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────┐
│         Top-K 选择与阈值过滤                                 │
│  - 按得分排序                                                │
│  - 选出 Top-K 作为目标持仓集合                              │
│  - 如得分均低于阈值，则清仓不持仓                           │
└──────────────────────────────────────────────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────────────────────┐
│       仓位计算与交易执行 (ETFRotationStrategy.backtest)      │
│  - 无再平衡：仅在轮动日卖出/买入                            │
│  - 有再平衡：在轮动日 + 再平衡日调整仓位                    │
│  - 应用滑点与手续费                                         │
└──────────────────────────────────────────────────────────────┘
```

### 1.2 核心参数

- **Top-K**：同时持有的 ETF 数量（默认 1 只）。
- **轮动间隔（rotation_interval）**：每隔 N 个交易日重新评估并轮动（默认 5 天）。
- **回看天数（lookback_days）**：计算技术指标得分时使用的历史窗口长度（默认 20 天）。
- **再平衡间隔（rebalance_interval，可选）**：
  - 为空：无再平衡模式，仅在轮动日换仓；
  - 非空：在再平衡日对保持的 ETF 做仓位调整。
- **总仓位目标**：默认 95%（保留 5% 作为现金缓冲）。
- **最低得分阈值（min_score_threshold）**：
  - 若所有 ETF 得分低于此阈值，则当期清仓不持仓。
- **仓位策略（position_strategy）**：
  - `equal`：等权重，即持仓 ETF 之间资金基本平均；
  - `kelly`：基于历史收益与波动的凯利公式权重（扩展模块中使用）。

技术指标得分权重（动量/RSI/均线/MACD）在前端可配置，默认为：

- 动量：65%；RSI：10%；均线：15%；MACD：10%。

---

## 二、轮动与再平衡触发机制

### 2.1 轮动触发

策略在以下两种情况下会触发轮动评估：

1. **定期轮动**：`day_idx % rotation_interval == 0`
   - 每隔 `rotation_interval` 个交易日检查一次；
   - 如 `rotation_interval = 5`，则第 0、5、10、15... 天为轮动日。
2. **首次建仓**：`len(current_positions) == 0`
   - 如当前无任何持仓，立即根据得分开仓。

伪代码如下：

```python
if day_idx % rotation_interval == 0 or len(current_positions) == 0:
    run_rotation()  # 轮动日：重算得分，确定目标 Top-K
else:
    keep_positions()  # 非轮动日：仅记录权益
```

### 2.2 再平衡触发

在有再平衡模式下，还会在再平衡日触发仓位调整：

- **无再平衡**：
  - 仅在轮动日执行卖出/买入，保持的 ETF 不调整仓位。
- **有再平衡**：
  - 在轮动日执行完整轮动过程（卖出/买入/调整保持 ETF）；
  - 在非轮动日的再平衡点，仅对**保持的 ETF**调整到等权（或目标权重），不更换标的。

整体流程可以抽象为：

```
每个交易日：
  ├─ 若满足轮动条件 → 运行轮动逻辑（卖出/调整/买入）
  ├─ 否则若满足再平衡条件 → 仅对保持ETF调整仓位
  └─ 计算并记录当日权益
```

---

## 三、ETF 分类与交易决策

在一个轮动日，算法首先按综合得分选择目标 Top-K 集合，然后将当前持仓与目标集合对比，将 ETF 分为三类：

### 3.1 需要卖出的 ETF (`etfs_to_sell`)

- **定义**：当前持有，但不在目标 Top-K 列表中的 ETF。
- **处理方式**：
  - 全部卖出：清空该 ETF 的所有持仓。
  - 记录交易类型为「轮动卖出」。  
- **计算公式**：

```text
卖出价格 = 收盘价 × (1 - slippage)
卖出收入 = 持仓股数 × 卖出价格 × (1 - commission_rate)
```

### 3.2 需要买入的 ETF (`etfs_to_buy`)

- **定义**：在目标 Top-K 列表中，但当前未持有的 ETF。
- **处理方式**：
  - 新建仓买入，按等权重或策略权重分配目标市值。
- **计算公式**（等权重情形）：

```text
买入价格 = 收盘价 × (1 + slippage)
目标市值 = 当前总资产 × (95% / Top-K)
目标股数 = 目标市值 / 买入价格（向下取整）
买入成本 = 目标股数 × 买入价格 × (1 + commission_rate)
```

### 3.3 需要保持的 ETF (`etfs_to_keep`)

- **定义**：既在当前持仓中，又在目标 Top-K 列表中的 ETF。
- **处理方式**：
  - 无再平衡模式：轮动日仍可调整仓位；非轮动日不动仓位。
  - 有再平衡模式：在轮动日和再平衡日都会对保持的 ETF 调整仓位至目标权重。
- **目标调整公式**：

```text
当前市值 = 当前持仓股数 × 当前收盘价
目标市值 = 当前总资产 × (95% / Top-K)
目标股数 = 目标市值 / 当前收盘价（向下取整）
差额股数 = 目标股数 - 当前持仓股数

若 差额股数 > 0 → 加仓
若 差额股数 < 0 → 减仓
若 差额股数 = 0 → 无需调整
```

对应的加仓/减仓成本与收入同样需要套用滑点与手续费。

---

## 四、交易执行顺序

为了确保资金正确流转与仓位准确分配，交易按以下**严格顺序**执行：

### 4.1 步骤细化

```text
步骤1: 卖出不需要的 ETF (etfs_to_sell)
  ├─ 遍历所有需要卖出的 ETF
  ├─ 按收盘价 × (1 - slippage) 卖出
  ├─ 扣除手续费后，资金回笼到 capital
  └─ 从 current_positions 中删除该 ETF

步骤2: 重新计算总资产
  ├─ 总资产 = 现金 (capital)
  └─ + 所有保持 ETF 的当前市值

步骤3: 调整保持的 ETF 仓位 (etfs_to_keep)
  ├─ 计算每个 ETF 的目标仓位（等权或自定义权重）
  ├─ 比较当前持仓 vs 目标持仓
  ├─ 执行加仓或减仓操作
  └─ 更新 current_positions

步骤4: 买入新的 ETF (etfs_to_buy)
  ├─ 遍历所有需要买入的 ETF
  ├─ 按等权或权重计算目标仓位
  ├─ 按收盘价 × (1 + slippage) 买入
  ├─ 扣除手续费后，从 capital 扣除
  └─ 添加到 current_positions
```

### 4.2 顺序设计的原因

1. **先卖出**：释放资金，为后续买入和加仓提供充足现金；
2. **再调整保持 ETF**：在卖出之后重新计算总资产，确保目标权重基于最新资金体量；
3. **最后买入新 ETF**：使用剩余资金建立新的持仓，避免资金不足导致买入失败。

---

## 五、仓位与价格计算

### 5.1 总资产计算

在每次轮动或再平衡前，需要先计算当前总资产：

```python
当前总资产 = 现金余额 + Σ(保持ETF的当前市值)

其中：
  现金余额 = capital  # 卖出 ETF 后回笼的资金
  保持 ETF 市值 = 持仓股数 × 当前收盘价
```

### 5.2 目标权重与目标股数

**等权重示意**：

```text
每个 ETF 的目标权重 = 95% / Top-K

例如：
  Top-K = 1 → 单个 ETF 占 95%
  Top-K = 2 → 每个 ETF 占 47.5%
  Top-K = 3 → 每个 ETF 占 31.67%
  Top-K = 5 → 每个 ETF 占 19%
```

**目标市值与股数**：

```text
目标市值 = 当前总资产 × 目标权重
目标股数 = 目标市值 / 当前价格（向下取整）

注意：向下取整会保留部分资金为现金，实际总仓位略低于 95%。
```

### 5.3 成交价格、成本与收入

**买入价格与成本**：

```text
买入价格 = 收盘价 × (1 + slippage)
         = 收盘价 × (1 + 0.001)  # 默认滑点 0.1%

买入股数 = int(目标市值 / 买入价格)

买入成本 = 买入股数 × 买入价格 × (1 + commission_rate)
        = 买入股数 × 买入价格 × (1 + 0.0003)  # 默认手续费 0.03%
```

**卖出价格与收入**：

```text
卖出价格 = 收盘价 × (1 - slippage)
         = 收盘价 × (1 - 0.001)

卖出收入 = 卖出股数 × 卖出价格 × (1 - commission_rate)
        = 卖出股数 × 卖出价格 × (1 - 0.0003)
```

**默认参数**：

- 滑点 (`slippage`)：0.1% (`0.001`)；
- 手续费率 (`commission_rate`)：0.03% (`0.0003`)。

---

## 六、交易类型与记录格式

为方便前端展示与回溯分析，策略将每笔交易记录为结构化对象。

### 6.1 轮动卖出 (Sell - Rotation)

**触发条件**：ETF 不在 Top-K 列表中，需要全部卖出。

```python
{
    "type": "sell",
    "etf_code": "510300",
    "price": 4.50,        # 卖出价格（含滑点）
    "shares": 1000,       # 卖出股数
    "revenue": 4498.65,   # 卖出收入（扣除手续费）
    "reason": "轮动卖出（不在 top-1）"
}
```

### 6.2 轮动买入 (Buy - Rotation)

**触发条件**：ETF 进入 Top-K 列表，需要新建仓买入。

```python
{
    "type": "buy",
    "etf_code": "510500",
    "price": 6.01,        # 买入价格（含滑点）
    "shares": 1500,       # 买入股数
    "cost": 9034.52,      # 买入成本（含手续费）
    "score": 85.5,        # ETF 得分
    "reason": "轮动买入（得分 85.5，top-1）"
}
```

### 6.3 加仓 (Buy - Add Position)

**触发条件**：ETF 仍在 Top-K 中，但当前持仓 < 目标持仓。

```python
{
    "type": "buy",
    "etf_code": "159915",
    "price": 2.50,        # 买入价格（含滑点）
    "shares": 200,        # 加仓股数（差额部分）
    "cost": 500.15,       # 加仓成本（含手续费）
    "score": 82.3,        # ETF 得分
    "reason": "加仓（得分 82.3）"
}
```

### 6.4 减仓 (Sell - Reduce Position)

**触发条件**：ETF 仍在 Top-K 中，但当前持仓 > 目标持仓。

```python
{
    "type": "sell",
    "etf_code": "159915",
    "price": 2.50,        # 卖出价格（含滑点）
    "shares": 100,        # 减仓股数（差额部分）
    "revenue": 249.93,    # 减仓收入（扣除手续费）
    "reason": "减仓调整"
}
```

---

## 七、示例场景

### 7.1 场景一：Top-K = 1，简单轮动

**初始状态**：

- 现金：¥100,000；
- 持仓：无。

**第 0 天（首次建仓）**：

- ETF 得分：510300=85，510500=80，159915=75；
- Top-1：510300；
- 操作：买入 510300：
  - 目标市值 = 100,000 × 95% = 95,000；
  - 买入价格 = 4.50 × 1.001 ≈ 4.5045；
  - 买入股数 ≈ 95,000 / 4.5045 ≈ 21,088；
  - 买入成本 ≈ 21,088 × 4.5045 × 1.0003 ≈ 95,014.5；
  - 剩余现金 ≈ 4,985.5。

**第 5 天（轮动）**：

- ETF 得分：510300=82，510500=88，159915=75；
- Top-1：510500（替换）；
- 当前持仓：510300 (21,088 股)；
- 当前总资产 ≈ 4,985.5 + 21,088 × 4.52 ≈ 100,300。

执行顺序：

1. **卖出 510300**：
   - 卖出价格 ≈ 4.52 × 0.999 ≈ 4.5155；
   - 卖出收入 ≈ 21,088 × 4.5155 × (1 - 0.0003) ≈ 95,234.5；
   - 现金 ≈ 4,985.5 + 95,234.5 ≈ 100,220。
2. **买入 510500**：
   - 目标市值 ≈ 100,300 × 95% ≈ 95,285；
   - 买入价格 ≈ 6.00 × 1.001 ≈ 6.006；
   - 买入股数 ≈ 95,285 / 6.006 ≈ 15,870；
   - 买入成本 ≈ 95,310.5；
   - 剩余现金 ≈ 4,909.5。

### 7.2 场景二：Top-K = 2，等权重调整

**初始状态**：

- 现金：¥100,000；
- 持仓：510300 (10,000 股)，510500 (8,000 股)。

**第 5 天（轮动）**：

- ETF 得分：510300=85，510500=82，159915=88；
- Top-2：510300、159915（510500 被替换）；
- 当前总资产 = 现金 + 510300 市值 + 510500 市值。

执行顺序：

1. 卖出 510500，资金回笼；
2. 根据总资产目标权重（47.5%）调整 510300 仓位（可能加仓或减仓）；
3. 按等权目标市值买入 159915。

### 7.3 场景三：Top-K = 3，仅做仓位微调

**初始状态**：

- 现金：¥100,000；
- 持仓：510300 (5,000 股)，510500 (4,000 股)，159915 (3,000 股)。

**第 5 天（轮动）**：

- Top-3 仍为 510300、510500、159915；
- 当前总资产 = 现金 + 三个 ETF 的市值总和。

执行顺序：

1. 无卖出操作（所有 ETF 都在 Top-3 中）；
2. 根据 95% / 3 ≈ 31.67% 的目标权重，对三只 ETF 分别加/减仓；
3. 无新增买入操作。

---

## 八、关键要点总结

- **交易顺序**：先卖后调再买，保证资金与目标权重的一致性；
- **等权/权重分配**：Top-K ETF 之间的权重由总仓位目标与配置策略共同决定；
- **成本因素**：所有交易都会考虑滑点与手续费，对回测结果有非忽略影响；
- **参数影响**：
  - `rotation_interval` 越短，交易越频繁，滑点与手续费影响越大；
  - `lookback_days` 影响得分稳定性与响应速度；
  - `min_score_threshold` 决定「不持仓」的门槛。

在使用本策略进行实盘或接近实盘的评估时，建议在 ETF 池、轮动间隔、阈值与再平衡参数上做多组实验，以观察策略对参数的敏感度与稳健性。

使用与模拟盘操作说明见 [ETF轮动前端与模拟盘.md](ETF轮动前端与模拟盘.md)。
